## 网络 5 层分层
* 应用层
* 运输层
* 网络层
* 链路层
* 物理层

### 应用层
对应协议：HTTP、FTP

#### HTTP
* HTTP 非持续连接的缺点：时间和空间的浪费
    - 每个请求创建一个连接，增加 web server 的负担。
    - 每个对象需经受 2 倍的 RTT 交付时间。

* HTTP 报文
    - 请求报文的通用格式：请求行(方法、URL、版本)、首部行(首部字段)、空行、实体体(POST 使用传递参数)。
    - 响应报文的通用格式：状态行(版本、状态码、短语)、首部行、空行、实体体()。
* 请求行方法：GET、POST、HEAD、PUT、DELETE。`用表单生成的数据不是必须使用 POST 方法。`
* 状态码：200、301、400、404、500、505。
* HTTP 是无状态的连接，它是如何识别用户的？
使用 cookie。cookie 在无状态的 HTTP 上建立了一个用户会话层。cookie 的争议：侵犯用户隐私。
* cookie 的使用到的组件：HTTP响应报文/HTTP 请求报文中的 cookie 首部行；用户端系统保留的 cookie 文件，由浏览器管理；web 站点的后端数据库。cookie 的内容为 唯一标识码。

* web 缓存/代理服务器
    - 用户发请求到缓存器，若缓存器存在请求对象，则直接返回请求对象。
    - 若不存在则缓存器在将请求转发给初始服务器，初始服务器将请求对象返回给缓存器。
    - 缓存器将请求对象缓存并返回给用户。
好处：节约流量，改善性能。

* 如何解决缓存器数据过时的问题？
通过条件 GET (Conditional GET) 解决。
    - 请求报文使用 GET 方法。
    - 请求报文中包含 `If-Modified-Since` 首部行。

#### SMTP
* 一般不使用中间邮件服务器。
* 默认使用的端口为 25。底层使用的是 TCP。
* 流程：send agent -> send server -> recive agent -> recive server。

#### HTTP 与 SMTP
* HTTP 是拉协议；SMTP 是推协议。
* SMTP 要求每个报文采用 7 比特 ASCII码，HTTP 没有这个限制。
* 处理包含文本又包含图形的文档方式不同，HTTP 将各自的对象放在各自的响应报文中；SMTP将所有的报文对象放在一个报文中。

#### DNS(Domain Name System)
* DNS 位于应用层。默认端口为 53。运行于 UDP 之上。
* 识别主机的两种方式：主机名/IP地址(IPv4 4字节)。
* DNS 是一个又分层的 DNS 服务器实现的分布式数据库；一个能使主机查询分布式数据库的应用层协议。
* DNS 其他的重要服务：主机别名、邮件服务器别名、负载分配。
* DNS 为何采用分布式架构而不是单体架构
    - 单点故障会导致整个网络瘫痪
    - 通信容量巨大
    - 远距离的集中式数据库导致很高的时延
    - 维护成本高

* DNS 服务器层级
    - 根 DNS 服务器
    - 顶级域 DNS 服务器
    - 权威 DNS 服务器

* DNS 缓存
    - 缓存一般会在两天后移除。
* DNS 的资源记录
    - 资源记录包含四个字段：Name、Value、Type、TTL。
    - 若 Type 为 A，则 Name 为主机名；若 Type 为 NS，则 Name 是个域；若 Type 为 CNAME，则 Value 为 别名为 Name 的主机对应的规范主机名；若 Type 为 MX，则 Value 是别名为 Name 的邮件服务器的规范主机名。
    - TTL 代表记录的生存时间。
* BitTorrent：P2P 文件分发协议。
* CDN(Content Distribution Network)：优化服务器的性能；缓解服务器的压力。
* TCP/UDP 的套接字 demo。

### 运输层
* 网络层为主机之间提供逻辑通信；运输层为运行在不同主机上的进程之间提供了逻辑通信。
* 运输层运行在端系统。

对应协议：TCP(Transfer Control Protocol)、UDP(User Data Protocol)

* 多路复用：在源主机从不同套接字中收集数据块，并为每个数据块封装上首部信息，从而生成报文段，然后将报文段传递到网络层。 - 收集
* 多路分解：在目的主机将运输层报文段中的数据交付到正确的套接字。- 分发
* UDP 的套接字由一个二元组标识：（目的 IP 地址；目的端口号）。
* TCP 的套接字由一个四元祖标识：（源 IP 地址；源端口号；目的 IP 地址；目的端口号）。

#### UDP
* 无连接、不可靠的运输层协议。
* 采用 UDP 的原因：
    - 关于发送什么数据以及何时发送的应用层控制更为精细。
    - 无需建立连接。
    - 无连接状态。
    - 分组首部开销小。
    总结：速度快，占用内存小。

* UDP 的报文结构：
    - 源端口号、目的端口号。
    - 长度、检验和。
    - 应用数据。
 
* 检验和提供了差错检测功能：
    - 将所有 16 bit 字的求和。求和时遇到的任何溢出都被回卷。
    - 将和进行反码运算。

* UDP 为什么要提供差错检测？
    - 用来确保数据的正确性和完整性。
    - 当发生差错时，UDP 会直接丢弃包。

* 可靠性的定义：数据按序、无损到达。
* 如何解决 ACK、NAK 报文含糊不清的情况？使用序号。
* 通过检验和、序号、定时器、肯定和否定确认分组来实现数据的可靠性。
* Pipeline 给可靠性数据带来的影响
    - 增加序号范围。
    - 发送方和接收方必须缓存多个分组。
    - 如何处理丢失、损坏及延时过大的分组。

* Pipeline 差错恢复的两种方法：
    - 回退 N 步（GBN），也被称为滑动窗口协议。
    - 选择重传（SR）。

* GBN 发送方响应的三个事件：
    - 上层的调用。
    - 收到一个 ACK。
    - 超时事件。
* GBN 接收方不会缓存任何失序分组。优点是接收缓存简单，缺点是不必要的重传。
* 对 SR 而言，发送方和接收方的窗口并不总是一致。
* SR 发送方的事件：
    - 从上层接受数据。
    - 超时。
    - 收到 ACK。

* 可靠数据传输机制及其用途的总结
    - 检验和：用于检测传输分组中的比特错误。
    - 定时器：用于超时、重传一个分组，可能因为该分组在信道中丢失了。
    - 序号：用于为从发送方流向接收方的数据分组按顺序编号。
    - 确认：接收方告知发送方分组已被正确的收到。
    - 否定确认：接收方告知发送方分组未被正确的收到。
    - 窗口、流水线：对停等协议的优化。通过允许一次发送多个分组但未被确认，发送方的利用率可在停等操作模式的基础上得打增加。

#### TCP 
* TCP 提供全双工服务；且连接是点对点。
* 报文长度短语：
    - 最大报文段长度（Maximum segment size）- MSS。一般为1460字节。
    - 最大传输单位（Maximum Transmission unit） - MTU。一般为1500字节。
* TCP 报文段结构：
    - 源端口号、目的端口号。
    - 序号。
    - 确认号。
    - 首部长度、保留未用、CWR、ECE、URG、ACK、PSH、RST、SYN、FIN、接受窗口。
    - 因特网检验和、紧急数据指针。
    - 选项。
    - 数据。
* TCP 的初始序号为什么要选择随机数？- 减少报文段错误的情况。
* Telnet 运行在 TCP 之上。
* RTT：动态估算改变。
* TCP 所有传输报文使用单一定时器。
* 流量控制服务
    - 接收方会维护一个窗口来接收缓存。
    - 可用缓存：rwnd = RcVBuffer - [LastByteRcvd - LastByteRead]
    - 当 rwnd 为 0 时，发送方会继续发送只有一个字节数据的报文段，防止接收方有缓存空间而发送方仍然被阻塞。
* TCP 三次握手
    - client -> server，SYN 标志位为1，不包含应用层数据，被称为 SYN 报文段。它会随机给序号生成一个初始值： client_isn（用来防止网络攻击）。
    - server -> client，SYN 标志位为1，被称为 SYNACK 报文段。确认号（ack）为 client_isn + 1，序号（seq）为 server_isn。
    - client -> server，SYN 标志位为 0。确认好（ack） 为 server_isn + 1，序号（seq） 为  client_isn + 1。至此，连接建立。
* 为什么需要三次握手？两次行不行？
握手主要为了同步序号，两次并不能同步。
* 为什么初始序号要随机，而不是从 0 开始？
* TCP 四次挥手
    - client -> server，FIN 包。
    - server -> client，ACK 包。
    - server -> client，FIN 包。
    - client -> server，ACK 包。定时等待一段时间(典型的值为 30s、1min、2min)后关闭连接。
* 四次挥手为什么要等待一段时间再断开连接？
* SYN 泛洪攻击如何防范：SYN cookie
    - server 接受到报文段不会立即创建 TCP 连接，而是生成一个序列号(通过仅 server 知道的散列函数生成)。且 server 不会缓存该 cookie 或者对应 SYN 的其他信息。
    - 如果 client 合法，它将返回一个 ACK 报文段。server 会根据 ACK 报文段来验证之前的序列号。
    - 若 client 未返回报文段，则 server 不会分配任何资源。

* 扫描端口(向目的主机发送 SYN 包)的三种结果：
    - 收到 SYNACK 报文段，说明该端口打开。
    - 接收到 RST 报文段，说明该端口未运行应用程序。
    - 什么也没收到，说明被防火墙隔断。

* 网络阻塞的代价
    - 发送方必须执行重传以补偿缓存溢出而丢弃的分组。
    - 发送方不必要的重传会引起路由器利用其链路带宽来转发不必要的分组。
    - 由于拥塞而丢弃分组最终浪费了上游路由器的传输容量。

* 拥塞控制的方法
    - 端到端拥塞控制(TCP 采用该方法)。
    - 网络辅助的拥塞控制。

* TCP 拥塞控制
    - TCP 发送方如何限制发送流量的速率？答：通过调节拥塞窗口的值来调整发送速率。
    - TCP 发送方如何感知路径存在拥塞？答：当出现丢包时，则发送方认定路径存在拥塞。
    - 当发送方感知的拥塞时，用何种算法来改变发送速率？答：TCP 控制拥塞算法。

* TCP 控制拥塞算法(加性增，乘性减)
    - 慢启动：起始为 1 个 MSS，后续每次确认数据量翻倍。
    - 拥塞避免
    - 快速恢复

* 慢启动结束
    - 当丢包时，慢启动的指数增长会结束。cwnd 设置为 1 个 MSS，并且将慢启动阈值设为 cwnd/2。
    - 当慢启动阈值为 cwnd/2 时，若 cwnd 到达或超过慢启动阈值时，结束慢启动并且 TCP 转移到拥塞避免模式。
    - 检测到 3 个冗余 ACK，TCP 会执行快速重传并进入快速恢复状态。

* 如何优化用户端远离数据中心导致时延很大的情况
    - 部署临近用户的前端服务器。
    - 使用 TCP 分岔来分裂 TCP 连接。
    - TCP 分岔大约能将 4 * RTT 优化到 RTT。

* 拥塞避免
    - 进入拥塞避免状态，每个 RTT 直将 cwnd 的值增加一个 MSS。
    - 当出现超时时，行为与慢启动一致。cwnd 设置为 1 个 MSS，并且将慢启动阈值设为 cwnd/2。

* 快速恢复
    - TCP 推荐而非必须的构建。
    - 当出现超时事件时，执行慢启动和拥塞避免一致的行为，并迁移到慢启动装填。
    - 当丢包事件出现时，cwnd 设置为 1 个 MSS，并且将慢启动阈值设为 cwnd/2。

#### UDP 与 TCP 总结

### 网络层
对应协议：IP
#### 数据平面
* 网络层功能：
    - 转发，将分组移动到合适的输出链路。本地操作，一般由硬件实现。由数据平面执行的主要功能。
    - 路由选择，通过路由选择算法来决定分组所采用的的路由或路径。通常由软件实现。
* 转发表用来存储分组的输出路径。
* SDN (Software-Defined Networking) - 软件定义网络。通过远程控制器来计算并分发转发表。
* 网络层提供尽力而为服务(best-effort service)。
* 位于链路层的交换机被称为-链路层交换机；位于网络层的交换机被称为-路由器。
* 路由器的四个组件：
    - 输入端口
    - 交换结构
    - 输出端口
    - 路由选择处理器
* 输入端口


### 链路层
对应协议：

### 物理层
对应协议：



### 硬件工作原理、名词解释
* 集线器
* 链路层交换机
* 路由器
* IP（Internet Protool） 地址：位于网络层，24 位(IPv4) 或 48 位 (IPv6) ，运营商提供，可修改，用来定位计算机的逻辑地址。
* MAC（Media Access Control） 地址：位于数据链路层，48位（6字节），厂家烧制，不可修改，用来定位计算机的物理地址。
* 为什么有了 Mac 地址还需要 IP 地址？
